#!/bin/sh
#
# Flush the sole varnish cache
#

#
#  If you're not using varnish unset this.
#
host=212.110.179.78:6082


#
#  If we have a host then set the flag.
#
if [ ! -z "$host" ]; then
  host="-T $host"
fi


#
#  If we have varnishadmin then purge the site
#
if [ -x /usr/bin/varnishadm ] ; then
    if ( varnishadm $host 'ban req.url ~ /' >/dev/null 2>/dev/null ); then
        if [ -x /root/current/bin/alert ]; then
            /root/current/bin/alert "varnish cache flushed"
        fi
    else
         if [ -x /root/current/bin/alert ]; then
            /root/current/bin/alert "varnish cache flush failed"
        fi
    fi
fi
