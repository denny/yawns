#
#  Make sure that we turn on the rewriting engine.
#
RewriteEngine on



#
#  Rules to clean up old inbound links using
#
#  ?article=x   -> /cgi-bin/articles/x
#  ?poll=x      -> /cgi-bin/polls/x
#  ?printable=x -> /cgi-bin/articles/x/print
#
RewriteCond %{query_string} /index.cgi?article=([0-9]+) [NC]
RewriteRule .* http://%{SERVER_NAME}/articles/%1? [R=301,L]

RewriteCond %{query_string} /index.cgi?poll=([0-9]+) [NC]
RewriteRule .* http://%{SERVER_NAME}/polls/%1? [R=301,L]

RewriteCond %{query_string} /index.cgi?printable=([0-9]+) [NC]
RewriteRule .* http://%{SERVER_NAME}/articles/%1/print? [R=301,L]

RewriteCond %{query_string} /index.cgi?submit=new [NC]
RewriteRule .* http://%{SERVER_NAME}/?  [R=301,L]

#
#  The /cgi-bin/topics/* links have been removed.
#
RewriteRule ^/topics/(.*)$ http://%{SERVER_NAME}/ [R=301,L]


#
#  Rewrite all the dead messaging stuff
#
RewriteRule ^/(create|delete|view|reply)/message  http://%{SERVER_NAME}/ [R=301,L]



#
#  Bookmark addition is gone.
#
RewriteRule ^/bookmark/onarticle/? http://%{SERVER_NAME}/ [R=301,L]
RewriteRule ^/bookmark/onpoll/?    http://%{SERVER_NAME}/ [R=301,L]
RewriteRule ^/bookmark/onweblog/?  http://%{SERVER_NAME}/ [R=301,L]


#
#  Poll submission stuff.
#
RewriteRule ^/submissions/polls/post/([0-9]+)/(.*)   /cgi-bin/index.cgi?poll_post=1;id=$1;session=$2   [PT]
RewriteRule ^/submissions/polls/delete/([0-9]+)/(.*)  /cgi-bin/index.cgi?poll_reject=1;id=$1;session=$2 [PT]
RewriteRule ^/submissions/polls/edit/([0-9]+)/(.*)  /cgi-bin/index.cgi?poll_edit=1;id=$1;session=$2 [PT]
RewriteRule ^/submissions/polls/*                 /cgi-bin/index.cgi?poll_submissions=1  [PT]


RewriteRule ^/submissions/* http://%{SERVER_NAME}/submission/list [R=301,L]

RewriteRule ^/add/submission/note/([0-9]+)/* /cgi-bin/index.cgi?add_submission_note=1;id=$1 [PT]

#
#  View a users scratchpad.
#
RewriteRule ^/users/([A-Za-z0-9_\-]+)/scratchpad$           /cgi-bin/index.cgi?scratchpad=$1 [PT]


#
#  View a users adverts
#
RewriteRule ^/users/([A-Za-z0-9_\-]+)/adverts$        /cgi-bin/index.cgi?adverts_byuser=$1 [PT]


#
#  View a users bookmarks.
#
RewriteRule ^/users/([A-Za-z0-9_\-]+)/bookmarks$           /cgi-bin/index.cgi?bookmarks=$1 [PT]


#
#  View the userinfo page for a particular user.
#
RewriteRule ^/users/([A-Za-z0-9_\-]+)$               /cgi-bin/index.cgi?user=$1       [PT]


#
#  View a users weblog entries.
#
RewriteRule ^/users/([A-Za-z0-9_\-]+)/weblog/*$               /cgi-bin/index.cgi?weblog=$1 [PT]

#
#  Or just a specific weblog entry.
#
RewriteRule ^/users/([A-Za-z0-9_\-]+)/weblog/([0-9]+)/*$      /cgi-bin/index.cgi?single_weblog=$1;item=$2 [PT]

#
#  Or page back through weblog entries.
#
RewriteRule ^/users/([A-Za-z0-9_\-]+)/weblog/start/([0-9]+)$      /cgi-bin/index.cgi?weblog=$1;start=$2 [PT]




#
#  View either a specific article, or the print version of the same.
#
#  The first rule here takes care of redirecting when people have trailing
# punctuation upon their inbound links.  Happens too often.  *sigh*
#

RewriteRule ^/articles/([0-9]+)[<>,\.;:]+$      /cgi-bin/articles/$1    [R]
RewriteRule ^/articles/([0-9]+)$                /cgi-bin/index.cgi?article=$1    [PT]
RewriteRule ^/articles/([0-9]+)/print$          /cgi-bin/index.cgi?printable=$1  [PT]


#
#  News handling
#
RewriteRule ^/News/feed/*               / [R=301,L]
RewriteRule ^/News/*                    / [R=301,L]
RewriteRule ^/about/News/*              / [R=301,L]
RewriteRule ^/create/News/*             / [R=301,L]

#
#  View a specific poll.
#
RewriteRule ^/polls/([0-9]+)$                   /cgi-bin/index.cgi?poll=$1     [PT]
RewriteRule ^/poll/archive/*                    /cgi-bin/index.cgi?poll_list=1 [PT]
RewriteRule ^/polls/*$                          /poll/archive [R=301,L]
RewriteRule ^/poll/*$                           /poll/archive [R=301,L]

#
#  View an 'about' page - text contained in the database.
#
RewriteRule ^/about/([^/]+)/*                  /cgi-bin/index.cgi?about=$1      [PT]

#
#  Frontpage stuff.
#
# View all articles from the given offset
#
RewriteRule ^/start/([0-9\/]+)$          /cgi-bin/index.cgi?start=$1      [PT]

#
#  "Hall of fame"
#
RewriteRule ^/hof/*$                       /cgi-bin/index.cgi?stats=1         [PT]


#
#  Dummy entries in case somebody explores our web tree.
#
RewriteRule ^/edit/*$                             /               [R]
RewriteRule ^/articles/*$                         /               [R]
RewriteRule ^/users/*$                            /               [R]
RewriteRule ^/create/*$                           /               [R]
RewriteRule ^/weblog/feeds*$                      /               [R]



#
#  Rules to create article submissions, weblog entries, new user accounts,
# or polls
#
#  These rules exist specifically so that we can use a 'robots.txt' file
# to disable spidering of these URLs.
#
RewriteRule ^/create/advert/*$               /cgi-bin/index.cgi?add_advert=new   [PT]
RewriteRule ^/create/article/*$              /cgi-bin/index.cgi?submit=new       [PT]
RewriteRule ^/create/poll/*$                 /cgi-bin/index.cgi?submit_poll=1    [PT]
RewriteRule ^/create/related/([0-9]+)        /cgi-bin/index.cgi?add_related=$1   [PT]
RewriteRule ^/create/user/*$                 /cgi-bin/index.cgi?new_user=create  [PT]
RewriteRule ^/create/weblog/*$               /cgi-bin/index.cgi?add_weblog=new   [PT]



#
#  Rules for creating new comments, on either polls or articles.
#
#  We also deal with replies to existing comments on either too.
#
#  These rules were specifically added to avoid spidering.
#
RewriteRule ^/comment$    /cgi-bin/index.cgi [PT]
RewriteRule ^/comment/onpoll/([0-9]+)$  /cgi-bin/index.cgi?comment=new;onpoll=$1 [PT]
RewriteRule ^/comment/onpoll/([0-9]+)/([0-9]+)$ /cgi-bin/index.cgi?comment=new;onpoll=$1;oncomment=$2 [PT]

RewriteRule ^/comment/onarticle/([0-9]+)$ /cgi-bin/index.cgi?comment=new;onarticle=$1 [PT]
RewriteRule ^/comment/onarticle/([0-9]+)/([0-9]+)$ /cgi-bin/index.cgi?comment=new;onarticle=$1;oncomment=$2 [PT]

RewriteRule ^/comment/onweblog/([0-9]+)$  /cgi-bin/index.cgi?comment=new;onweblog=$1 [PT]
RewriteRule ^/comment/onweblog/([0-9]+)/([0-9]+)$ /cgi-bin/index.cgi?comment=new;onweblog=$1;oncomment=$2 [PT]


#
#  Edit articles, users, weblogs, preferences, scratchpads, or about pages.
#
RewriteRule ^/edit/weblog/([0-9]+)              /cgi-bin/index.cgi?edit_weblog=$1           [PT]
RewriteRule ^/edit/article/([0-9]+)             /cgi-bin/index.cgi?edit_article=$1          [PT]
RewriteRule ^/edit/user/([A-Za-z0-9_\-]+)       /cgi-bin/index.cgi?edit_user=$1             [PT]
RewriteRule ^/edit/user/*          /cgi-bin/index.cgi?edit_user=1              [PT]

RewriteRule ^/edit/prefs/([A-Za-z0-9_\-]+)      /cgi-bin/index.cgi?edit_prefs=$1            [PT]
RewriteRule ^/edit/prefs/*          /cgi-bin/index.cgi?edit_prefs=1             [PT]

RewriteRule ^/edit/permissions/([A-Za-z0-9_\-]+)      /cgi-bin/index.cgi?edit_permissions=$1 [PT]

RewriteRule ^/edit/scratchpad/([A-Za-z0-9_\-]+) /cgi-bin/index.cgi?edit_scratchpad=$1       [PT]
RewriteRule ^/edit/scratchpad/*   /cgi-bin/index.cgi?edit_scratchpad=1        [PT]
RewriteRule ^/edit/about/(.*)$                  /cgi-bin/index.cgi?edit_about=edit_page&page=$1 [PT]
RewriteRule ^/edit/about/*                      /cgi-bin/index.cgi?edit_about=pick          [PT]

#
#  Edit comments.
#
RewriteRule ^/edit/comment/onpoll/([0-9]+)/([0-9]+)/(.*)  /cgi-bin/index.cgi?edit_comment=1;poll_id=$1;comment_id=$2;session=$3  [PT]
RewriteRule ^/edit/comment/onarticle/([0-9]+)/([0-9]+)/(.*)         /cgi-bin/index.cgi?edit_comment=1;article_id=$1;comment_id=$2;session=$3 [PT]
RewriteRule ^/edit/comment/onweblog/([0-9]+)/([0-9]+)/(.*)  /cgi-bin/index.cgi?edit_comment=1;weblog_id=$1;comment_id=$2;session=$3  [PT]

#
# Show recent comments, or users.
#
RewriteRule ^/recent/users/([0-9]+)$          /cgi-bin/index.cgi?recent_users=$1        [PT]
RewriteRule ^/recent/users/*$                 /cgi-bin/index.cgi?recent_users=1         [PT]

#
#  Show/Edit pending article submissions
#
RewriteRule ^/submission/feed/*                   /cgi-bin/feeds.cgi?pending_submissions_feed=1  [PT]
RewriteRule ^/submission/list/*                   /cgi-bin/index.cgi?submission_list=1  [PT]
RewriteRule ^/view/submission/([0-9]+)            /cgi-bin/index.cgi?submission_view=$1 [PT]
RewriteRule ^/edit/submission/([0-9]+)/(.*)   /cgi-bin/index.cgi?submission_edit=$1;session=$2 [PT]
RewriteRule ^/post/submission/([0-9]+)/(.*)   /cgi-bin/index.cgi?submission_post=$1;session=$2 [PT]
RewriteRule ^/reject/submission/([0-9]+)/(.*)   /cgi-bin/index.cgi?submission_reject=$1;session=$2 [PT]



#
#  User menu options
#
RewriteRule ^/password/sendmail   /cgi-bin/index.cgi?send_reset_password=1 [PT]
RewriteRule ^/password/reset/([A-Za-z0-9_\-]+)/([A-Za-z0-9_\-]+)   /cgi-bin/index.cgi?change_password=1;user=$1;magic=$2     [PT]
RewriteRule ^/login/*           /cgi-bin/index.cgi?loginform=1           [PT]
RewriteRule ^/logout/(.*)   /cgi-bin/index.cgi?logout=now;session=$1 [PT]
RewriteRule ^/user/admin/*                      /cgi-bin/index.cgi?user_admin=1          [PT]

#
#  Advert options
#
RewriteRule ^/follow/([0-9]+)$   /cgi-bin/index.cgi?follow_advert=$1     [PT]
RewriteRule ^/follow/*     /cgi-bin/                      [R]
RewriteRule ^/adverts/all                       /cgi-bin/index.cgi?all_adverts=1        [PT]
RewriteRule ^/adverts/pending                   /cgi-bin/index.cgi?edit_adverts=1       [PT]
RewriteRule ^/adverts/([0-9]+)$   /cgi-bin/index.cgi?advert_stats=$1      [PT]
RewriteRule ^/adverts/disable/([0-9]+)/(.*)     /cgi-bin/index.cgi?disable_advert=$1;session=$2 [PT]
RewriteRule ^/adverts/delete/([0-9]+)/(.*)      /cgi-bin/index.cgi?delete_advert=$1;session=$2 [PT]
RewriteRule ^/adverts/enable/([0-9]+)/(.*)      /cgi-bin/index.cgi?enable_advert=$1;session=$2 [PT]

#
#  If a month is present then we'll ignore it.
#
RewriteRule ^/archive/([0-9]+)/([0-9]+)/*$   http://%{SERVER_NAME}/archive/%1 [R=301,L]

#
#  Archive options.
#
RewriteRule ^/archive/*$     /cgi-bin/index.cgi?archive=1    [PT]


RewriteRule ^/archive/([0-9]+)/*$   /cgi-bin/index.cgi?archive=1;year=$1    [PT]


RewriteRule ^/delete/user/([A-Za-z0-9_\-]+)  /cgi-bin/index.cgi?user_admin=delete;username=$1 [PT]
RewriteRule ^/delete/related/([0-9]+)/([0-9]+)/(.*)     /cgi-bin/index.cgi?delete_related=1;article_id=$1;id=$2;session=$3 [PT]
RewriteRule ^/delete/weblog/([0-9]+)           /cgi-bin/index.cgi?delete_weblog=$1 [PT]
RewriteRule ^/delete/bookmark/([0-9]+)/(.*)           /cgi-bin/index.cgi?delete_bookmark=$1;session=$2 [PT]


RewriteRule ^/search/byauthor/([A-Za-z0-9_\-]+)  /cgi-bin/index.cgi?author_search=$1  [PT]
RewriteRule ^/search/*$                                       /cgi-bin/search.cgi  [PT,QSA]


#
#  Report comment(s)
#
RewriteRule ^/report/comment/onpoll/([0-9]+)/([0-9]+)/(.*)  /cgi-bin/index.cgi?report=comment;poll_id=$1;comment_id=$2;session=$3  [PT]
RewriteRule ^/report/comment/onarticle/([0-9]+)/([0-9]+)/(.*) /cgi-bin/index.cgi?report=comment;article_id=$1;comment_id=$2;session=$3 [PT]
RewriteRule ^/report/comment/onweblog/([0-9]+)/([0-9]+)/(.*)  /cgi-bin/index.cgi?report=comment;weblog_id=$1;comment_id=$2;session=$3  [PT]
RewriteRule ^/report/weblog/([0-9]+)/(.*)/*                        /cgi-bin/index.cgi?report_weblog=$1;session=$2 [PT]



#
#  Ajax handlers for tag addition.
#
RewriteRule ^/ajax/addtag/submission/([0-9]+)/(.*)/*$   /cgi-bin/ajax.cgi?add_tag=1;submission=$1;new_tag=$2 [PT]
RewriteRule ^/ajax/addtag/weblog/([0-9]+)/(.*)/*$   /cgi-bin/ajax.cgi?add_tag=1;weblog=$1;new_tag=$2 [PT]
RewriteRule ^/ajax/addtag/poll/([0-9]+)/(.*)/*$   /cgi-bin/ajax.cgi?add_tag=1;poll=$1;new_tag=$2 [PT]
RewriteRule ^/ajax/addtag/([0-9]+)/(.*)/*$   /cgi-bin/ajax.cgi?add_tag=1;article=$1;new_tag=$2 [PT]

#
#  Get tags of a particular type
#
RewriteRule ^/ajax/tags/type/(.*)/*$   /cgi-bin/ajax.cgi?get_tags=1;type=$1 [PT]
RewriteRule ^/ajax/tags/recent         /cgi-bin/ajax.cgi?get_recent_tags=1 [PT]


#
#  Set posting format
#
RewriteRule ^/ajax/setformat/(.*)/*$         /cgi-bin/ajax.cgi?set_format=1;format=$1 [PT]



#
#  Feed Rules.
#
#
RewriteRule ^/recent/comments/([A-Za-z0-9_\-]+)/* /cgi-bin/f.cgi?mode=user_feed;user=$1 [PT]

RewriteRule ^/recent/comments/([0-9]+)$       /cgi-bin/f.cgi?mode=recent_comments;count=$1     [PT]
RewriteRule ^/recent/comments/*$              /cgi-bin/f.cgi?mode=recent_comments     [PT]

RewriteRule ^/recent/reported/weblogs/*$       /cgi-bin/feeds.cgi?reported_weblogs=$1     [PT]
RewriteRule ^/recent/reported/([0-9]+)$       /cgi-bin/feeds.cgi?recent_reported=$1     [PT]
RewriteRule ^/recent/reported/*$              /cgi-bin/feeds.cgi?recent_reported=10     [PT]

RewriteRule ^/comment/feed/onweblog/([0-9]+)$  /cgi-bin/feeds.cgi?comment_feed=1;weblog_id=$1 [PT]
RewriteRule ^/comment/feed/onpoll/([0-9]+)$    /cgi-bin/feeds.cgi?comment_feed=1;poll_id=$1 [PT]
RewriteRule ^/comment/feed/onarticle/([0-9]+)$ /cgi-bin/feeds.cgi?comment_feed=1;article_id=$1 [PT]

RewriteRule ^/weblog/feeds/([A-Za-z0-9_\-]+)$  /cgi-bin/f.cgi?mode=weblog_feed;user=$1 [PT]
RewriteRule ^/tag/feeds/(.*)$                  /cgi-bin/feeds.cgi?tag_feed=$1 [PT]


#
#  Tag rules, must come after /cgi-bin/tag/feeds
#
RewriteRule ^/tags/*$     /tag/ [R=301,L]
RewriteRule ^/tag/*$     /cgi-bin/index.cgi?tag_browse=1 [PT]
RewriteRule ^/tag/(.*)$            /cgi-bin/index.cgi?tag_search=$1 [PT]


#
#  Here we try to link by title - both for the printable version and the
# normal one.
#
RewriteRule ^/article/([0-9]+)/(.*)/print/*$    /cgi-bin/index.cgi?printable=$1    [PT]
RewriteRule ^/article/([0-9]+)/(.*)/*$          /cgi-bin/index.cgi?article=$1 [PT]

RewriteRule ^/article/(.*)/print/*$             /cgi-bin/index.cgi?title_print=$1 [PT]
RewriteRule ^/article/(.*)/*$                   /cgi-bin/index.cgi?title=$1 [PT]

#
#  Front-page
#
RewriteRule ^/$   /cgi-bin/index.cgi [PT]
