
#####
#######
#########
###
###  This Apache configuration file routes incoming "pretty" URLS to
### the actual handlers.
###
###  Handlers are broken down by functionality:
###
###      a.fcgi - AJAX handlers.
###
###      f.fcgi - RSS Feed handlers.
###
###      i.fcgi - Index handler.
###
###  We also still have a legacy/catch-all handler which is being retired:
###
###   index.cgi - Legacy handler
###
###
#####
#######
#########

#
#  Make sure that we turn on the rewriting engine.
#
RewriteEngine on


#
#  Dead Links
#
RewriteRule ^/topics/(.*)$                           / [R=301,L]
RewriteRule ^/(create|delete|view|reply)/message     / [R=301,L]
RewriteRule ^/bookmark/(onarticle|onpoll|onweblog)/? / [R=301,L]
RewriteRule ^/News/feed/*                            / [R=301,L]
RewriteRule ^/News/*                                 / [R=301,L]
RewriteRule ^/(about|create)/News/*                  / [R=301,L]


#
#  Poll submission stuff.
#
RewriteRule ^/submissions/polls/post/([0-9]+)/(.*)   /cgi-bin/index.cgi?poll_post=1;id=$1;session=$2   [PT]
RewriteRule ^/submissions/polls/delete/([0-9]+)/(.*) /cgi-bin/index.cgi?poll_reject=1;id=$1;session=$2 [PT]
RewriteRule ^/submissions/polls/edit/([0-9]+)/(.*)   /cgi-bin/index.cgi?poll_edit=1;id=$1;session=$2   [PT]
RewriteRule ^/submissions/polls/*                    /cgi-bin/index.cgi?poll_submissions=1             [PT]
RewriteRule ^/submissions/*                          /submission/list                                  [R=301,L]



#
#  Scratchpad support
#
RewriteRule ^/users/([A-Za-z0-9_\-]+)/scratchpad$  /cgi-bin/i.fcgi?mode=scratchpad;user=$1        [PT]
RewriteRule ^/edit/scratchpad/([A-Za-z0-9_\-]+)    /cgi-bin/i.fcgi?mode=edit_scratchpad;user=$1   [PT]
RewriteRule ^/edit/scratchpad/*                    /cgi-bin/i.fcgi?mode=edit_scratchpad           [PT]




#
#  bookmark-operations.
#
RewriteRule ^/users/([A-Za-z0-9_\-]+)/bookmarks$    /cgi-bin/i.fcgi?mode=view_bookmarks;user=$1 [PT]
RewriteRule ^/delete/bookmark/([0-9]+)/(.*)         /cgi-bin/i.fcgi?mode=delete_bookmark;id=$1;session=$2 [PT]


#
#  View the userinfo page for a particular user.
#
RewriteRule ^/users/([A-Za-z0-9_\-]+)/?$ /cgi-bin/i.fcgi?mode=view_user;user=$1       [PT]


#
#  View a users weblog entries.
#
RewriteRule ^/users/([A-Za-z0-9_\-]+)/weblog/*$              /cgi-bin/i.fcgi?mode=weblog;show=$1                [PT]
RewriteRule ^/users/([A-Za-z0-9_\-]+)/weblog/start/([0-9]+)$ /cgi-bin/i.fcgi?mode=weblog;show=$1;start=$2       [PT]
RewriteRule ^/users/([A-Za-z0-9_\-]+)/weblog/([0-9]+)/*$     /cgi-bin/i.fcgi?mode=single_weblog;show=$1;item=$2 [PT]




#
#  View either a specific article, or the print version of the same.
#
#  The first rule here takes care of redirecting when people have trailing
# punctuation upon their inbound links.  Happens too often.  *sigh*
#

#
#  OK the articles are viewed as:
#
#    /article/NN/TITLE
#
#  If we see /article/NN/?$ then this is an error.
#
#
#  Look for the article:
#
#    /article/NNNN/[<>.;l]   -> /article/N/$slug
#    /article/NNN/           -> /article/N/$slug
#    /article/$TITLE         -> /article/N/$slug
#
RewriteRule ^/articles?/([0-9]+)([<>,\.;:/])+$  /cgi-bin/i.fcgi?mode=article_wrapper;id=$1     [PT]
RewriteRule ^/articles?/([0-9]+)/?$             /cgi-bin/i.fcgi?mode=article_wrapper;id=$1     [PT]
RewriteRule ^/article/([0-9]+)/(.*)/?           /cgi-bin/i.fcgi?mode=article;id=$1             [PT]
RewriteRule ^/articles?/(.*)/?$                 /cgi-bin/i.fcgi?mode=article_wrapper;title=$1  [PT]
RewriteRule ^/article/?$                        /                                              [R]
RewriteRule ^/articles/?$                      /                                               [R]




#
#  View a specific poll.
#
RewriteRule ^/polls/([0-9]+)$                   /cgi-bin/index.cgi?poll=$1     [PT]
RewriteRule ^/poll/archive/*                    /cgi-bin/index.cgi?poll_list=1 [PT]
RewriteRule ^/polls?/?$                         /poll/archive                  [R=301,L]



#
#  About-Page handling.
#
RewriteRule ^/about/([^/]+)/*     /cgi-bin/i.fcgi?mode=about;about=$1     [PT]
RewriteRule ^/edit/about/(.*)$    /cgi-bin/i.fcgi?mode=edit_about;page=$1 [PT]
RewriteRule ^/edit/about/*        /cgi-bin/i.fcgi?mode=edit_about         [PT]


#
#  Frontpage stuff.
#
# View all articles from the given offset
#
RewriteRule ^/start/([0-9\/]+)$          /cgi-bin/i.fcgi?mode=index;start=$1  [PT]

#
#  "Hall of fame"
#
RewriteRule ^/hof/*$                       /cgi-bin/i.fcgi?mode=hof  [PT]


#
#  Dummy entries in case somebody explores our web tree.
#
RewriteRule ^/edit/*$                             /               [R]
RewriteRule ^/users/*$                            /               [R]
RewriteRule ^/create/*$                           /               [R]
RewriteRule ^/weblog/feeds*$                      /               [R]



#
#  Rules to create article submissions, weblog entries, new user accounts,
# or polls
#
#  These rules exist specifically so that we can use a 'robots.txt' file
# to disable spidering of these URLs.
#
RewriteRule ^/create/advert/*$          /cgi-bin/i.fcgi?mode=create_advert [PT]
RewriteRule ^/create/article/*$         /cgi-bin/index.cgi?submit=new      [PT]
RewriteRule ^/create/poll/*$            /cgi-bin/index.cgi?submit_poll=1   [PT]
RewriteRule ^/create/related/([0-9]+)   /cgi-bin/index.cgi?add_related=$1  [PT]
RewriteRule ^/create/user/*$            /cgi-bin/index.cgi?new_user=create [PT]
RewriteRule ^/create/weblog/*$          /cgi-bin/index.cgi?add_weblog=new  [PT]



#
#  Rules for creating new comments, on either polls or articles.
#
#  We also deal with replies to existing comments on either too.
#
#  These rules were specifically added to avoid spidering.
#
RewriteRule ^/comment$                                 /cgi-bin/index.cgi [PT]
RewriteRule ^/comment/onpoll/([0-9]+)$                 /cgi-bin/index.cgi?comment=new;onpoll=$1 [PT]
RewriteRule ^/comment/onpoll/([0-9]+)/([0-9]+)$        /cgi-bin/index.cgi?comment=new;onpoll=$1;oncomment=$2 [PT]
RewriteRule ^/comment/onarticle/([0-9]+)$              /cgi-bin/index.cgi?comment=new;onarticle=$1 [PT]
RewriteRule ^/comment/onarticle/([0-9]+)/([0-9]+)$     /cgi-bin/index.cgi?comment=new;onarticle=$1;oncomment=$2 [PT]
RewriteRule ^/comment/onweblog/([0-9]+)$               /cgi-bin/index.cgi?comment=new;onweblog=$1 [PT]
RewriteRule ^/comment/onweblog/([0-9]+)/([0-9]+)$      /cgi-bin/index.cgi?comment=new;onweblog=$1;oncomment=$2 [PT]


#
#  Edit articles, users, weblogs, preferences, scratchpads, or about pages.
#
RewriteRule ^/edit/weblog/([0-9]+)              /cgi-bin/index.cgi?edit_weblog=$1           [PT]
RewriteRule ^/edit/article/([0-9]+)             /cgi-bin/index.cgi?edit_article=$1          [PT]

# Edit a named/the current user.
RewriteRule ^/edit/user/([A-Za-z0-9_\-]+)  /cgi-bin/i.fcgi?mode=edit_user;user=$1             [PT]
RewriteRule ^/edit/user/*                  /cgi-bin/i.fcgi?mode=edit_user  [PT]

RewriteRule ^/edit/prefs/([A-Za-z0-9_\-]+)      /cgi-bin/index.cgi?edit_prefs=$1            [PT]
RewriteRule ^/edit/prefs/*                      /cgi-bin/index.cgi?edit_prefs=1             [PT]

RewriteRule ^/edit/permissions/([A-Za-z0-9_\-]+)  /cgi-bin/index.cgi?edit_permissions=$1    [PT]


#
#  Edit comments.
#
RewriteRule ^/edit/comment/onpoll/([0-9]+)/([0-9]+)/(.*)  /cgi-bin/index.cgi?edit_comment=1;poll_id=$1;comment_id=$2;session=$3  [PT]
RewriteRule ^/edit/comment/onarticle/([0-9]+)/([0-9]+)/(.*)         /cgi-bin/index.cgi?edit_comment=1;article_id=$1;comment_id=$2;session=$3 [PT]
RewriteRule ^/edit/comment/onweblog/([0-9]+)/([0-9]+)/(.*)  /cgi-bin/index.cgi?edit_comment=1;weblog_id=$1;comment_id=$2;session=$3  [PT]

#
# Show recent comments, or users.
#
RewriteRule ^/recent/users/([0-9]+)/?$ /cgi-bin/i.fcgi?mode=recent_users;count=$1        [PT]
RewriteRule ^/recent/users/*$          /cgi-bin/i.fcgi?mode=recent_users  [PT]

#
#  Show/Edit pending article submissions
#
RewriteRule ^/submission/feed/*                   /cgi-bin/f.fcgi?mode=pending_submissions  [PT]
RewriteRule ^/submission/list/*                   /cgi-bin/index.cgi?submission_list=1  [PT]
RewriteRule ^/view/submission/([0-9]+)            /cgi-bin/index.cgi?submission_view=$1 [PT]
RewriteRule ^/edit/submission/([0-9]+)/(.*)   /cgi-bin/i.fcgi?mode=submission_edit;id=$1;session=$2 [PT]
RewriteRule ^/post/submission/([0-9]+)/(.*)   /cgi-bin/i.fcgi?mode=submission_post;id=$1;session=$2 [PT]
RewriteRule ^/reject/submission/([0-9]+)/(.*)   /cgi-bin/i.fcgi?mode=submission_reject;id=$1;session=$2 [PT]



#
#  User menu options
#
RewriteRule ^/password/sendmail   /cgi-bin/index.cgi?send_reset_password=1 [PT]
RewriteRule ^/password/reset/([A-Za-z0-9_\-]+)/([A-Za-z0-9_\-]+)   /cgi-bin/index.cgi?change_password=1;user=$1;magic=$2     [PT]

RewriteRule ^/login/*        /cgi-bin/i.fcgi?mode=login             [PT]
RewriteRule ^/logout/(.*)   /cgi-bin/i.fcgi?mode=logout;session=$1 [PT]

RewriteRule ^/user/admin/*                      /cgi-bin/index.cgi?user_admin=1          [PT]

#
# Advert handling
#
RewriteRule ^/follow/([0-9]+)$   /cgi-bin/i.fcgi?mode=follow_advert;id=$1                            [PT]
RewriteRule ^/follow/*           /cgi-bin/                                                           [R]
RewriteRule ^/adverts/all                       /cgi-bin/i.fcgi?mode=view_all_adverts                [PT]
RewriteRule ^/adverts/pending                   /cgi-bin/i.fcgi?mode=edit_adverts                    [PT]
RewriteRule ^/adverts/([0-9]+)$                 /cgi-bin/i.fcgi?mode=advert_stats;id=$1              [PT]
RewriteRule ^/adverts/disable/([0-9]+)/(.*)     /cgi-bin/i.fcgi?mode=disable_advert;id=$1;session=$2 [PT]
RewriteRule ^/adverts/delete/([0-9]+)/(.*)      /cgi-bin/i.fcgi?mode=delete_advert;id=$1;session=$2  [PT]
RewriteRule ^/adverts/enable/([0-9]+)/(.*)      /cgi-bin/i.fcgi?mode=enable_advert;id=$1;session=$2  [PT]
RewriteRule ^/users/([A-Za-z0-9_\-]+)/adverts$  /cgi-bin/i.fcgi?mode=adverts_byuser;user=$1          [PT]


#
#  Archive options.
#
RewriteRule ^/archive/?$                    /cgi-bin/i.fcgi?mode=archive         [PT]
RewriteRule ^/archive/([0-9]+)/?$           /cgi-bin/i.fcgi?mode=archive;year=$1 [PT]
RewriteRule ^/archive/([0-9]+)/([0-9]+)/?$  /archive/$1/                         [R=301,L]


RewriteRule ^/delete/user/([A-Za-z0-9_\-]+)  /cgi-bin/index.cgi?user_admin=delete;username=$1 [PT]
RewriteRule ^/delete/related/([0-9]+)/([0-9]+)/(.*)     /cgi-bin/index.cgi?delete_related=1;article_id=$1;id=$2;session=$3 [PT]
RewriteRule ^/delete/weblog/([0-9]+)           /cgi-bin/index.cgi?delete_weblog=$1 [PT]



RewriteRule ^/search/byauthor/([A-Za-z0-9_\-]+)  /cgi-bin/index.cgi?author_search=$1  [PT]
RewriteRule ^/search/?                           /cgi-bin/i.fcgi?mode=article_search [PT]


#
#  Report comment(s)
#
RewriteRule ^/report/comment/onpoll/([0-9]+)/([0-9]+)/(.*)  /cgi-bin/index.cgi?report=comment;poll_id=$1;comment_id=$2;session=$3  [PT]
RewriteRule ^/report/comment/onarticle/([0-9]+)/([0-9]+)/(.*) /cgi-bin/index.cgi?report=comment;article_id=$1;comment_id=$2;session=$3 [PT]
RewriteRule ^/report/comment/onweblog/([0-9]+)/([0-9]+)/(.*)  /cgi-bin/index.cgi?report=comment;weblog_id=$1;comment_id=$2;session=$3  [PT]
RewriteRule ^/report/weblog/([0-9]+)/(.*)/*                        /cgi-bin/index.cgi?report_weblog=$1;session=$2 [PT]



#
#  Ajax handlers for tag addition.
#
RewriteRule ^/ajax/addtag/submission/([0-9]+)/(.*)/*$   /cgi-bin/a.fcgi?mode=add_tag;submission=$1;new_tag=$2 [PT]
RewriteRule ^/ajax/addtag/weblog/([0-9]+)/(.*)/*$       /cgi-bin/a.fcgi?mode=add_tag;weblog=$1;new_tag=$2     [PT]
RewriteRule ^/ajax/addtag/poll/([0-9]+)/(.*)/*$         /cgi-bin/a.fcgi?mode=add_tag;poll=$1;new_tag=$2       [PT]
RewriteRule ^/ajax/addtag/([0-9]+)/(.*)/*$              /cgi-bin/a.fcgi?mode=add_tag;article=$1;new_tag=$2    [PT]

#
#  Get tags of a particular type
#
RewriteRule ^/ajax/tags/type/(.*)/*$   /cgi-bin/a.fcgi?mode=get_tags;type=$1 [PT]
RewriteRule ^/ajax/tags/recent         /cgi-bin/a.fcgi?mode=recent_tags      [PT]

#
#  Complete a tag
#
RewriteRule ^/ajax/complete/*$   /cgi-bin/a.fcgi?mode=tag_complete [PT,QSA]

#
#  Set posting format
#
RewriteRule ^/ajax/setformat/(.*)/*$   /cgi-bin/a.fcgi?mode=set_format;format=$1 [PT]



#
#  Feed Rules.
#
#
RewriteRule ^/recent/comments/([A-Za-z0-9_\-]+)/* /cgi-bin/f.fcgi?mode=user_feed;user=$1          [PT]
RewriteRule ^/recent/comments/([0-9]+)$           /cgi-bin/f.fcgi?mode=recent_comments;count=$1   [PT]
RewriteRule ^/recent/comments/*$                  /cgi-bin/f.fcgi?mode=recent_comments            [PT]
RewriteRule ^/recent/reported/weblogs/*$          /cgi-bin/f.fcgi?mode=reported_weblogs           [PT]
RewriteRule ^/recent/reported/([0-9]+)$           /cgi-bin/f.fcgi?mode=recent_reported;count=$1   [PT]
RewriteRule ^/recent/reported/*$                  /cgi-bin/f.fcgi?mode=recent_reported            [PT]
RewriteRule ^/comment/feed/onweblog/([0-9]+)$     /cgi-bin/f.fcgi?mode=comment_feed;weblog_id=$1  [PT]
RewriteRule ^/comment/feed/onpoll/([0-9]+)$       /cgi-bin/f.fcgi?mode=comment_feed;poll_id=$1    [PT]
RewriteRule ^/comment/feed/onarticle/([0-9]+)$    /cgi-bin/f.fcgi?mode=comment_feed;article_id=$1 [PT]
RewriteRule ^/weblog/feeds/([A-Za-z0-9_\-]+)$     /cgi-bin/f.fcgi?mode=weblog_feed;user=$1        [PT]
RewriteRule ^/tag/feeds/(.*)$                     /cgi-bin/f.fcgi?mode=tag_feed;tag=$1            [PT]


#
#  Tag rules, must come after /cgi-bin/tag/feeds
#
RewriteRule ^/tags/*$    /tag/                                   [R=301,L]
RewriteRule ^/tag/*$     /cgi-bin/i.fcgi?mode=tag_cloud          [PT]
RewriteRule ^/tag/(.*)$  /cgi-bin/i.fcgi?mode=tag_search;tag=$1  [PT]


#
#  Front-page
#
RewriteRule ^/$   /cgi-bin/i.fcgi?mode=index [PT]
